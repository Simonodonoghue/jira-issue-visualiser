<!DOCTYPE html>
<html>

<head>
    <script type="text/javascript" src="https://d3js.org/d3.v2.js"></script>
    <style type="text/css">
        .link-to-do {
            stroke: rgb(182, 182, 182);
        }

        .link-in-progress {
            stroke: rgb(250, 100, 0);
            stroke-width: 4px;
        }

        .link-done {
            stroke: rgb(73, 141, 27);
        }

        .nodetext {
            pointer-events: none;
            font: 10px sans-serif;
            background-color: white;
        }
    </style>
</head>

<body>

    <script type="text/javascript">

        // Retrieve the authorization code from the query params
        const urlParams = new URLSearchParams(window.location.search);
        const myParam = urlParams.get('code');

        // Send the code to lambda and swap it for an access token
        var Http = new XMLHttpRequest();
        var url = 'https://jok6vsojnh.execute-api.eu-west-2.amazonaws.com/default/JiraNodeVisualiser-OAuth';
        Http.open("POST", url, true);
        Http.send(JSON.stringify({
            authCode: myParam
        }))

        Http.onreadystatechange = (e) => {
            if (Http.readyState == 4 && Http.status == 200) {
                console.log("auth response")
                console.log(JSON.parse(JSON.parse(Http.responseText)))
                var at = JSON.parse(JSON.parse(Http.responseText)).access_token

                if (!at) {
                    window.location = 'https://auth.atlassian.com/authorize?audience=api.atlassian.com&client_id=IbpP46v0z5mLlBLgI2CStabBldUwT9P0&scope=read%3Ajira-user%20read%3Ajira-work&redirect_uri=https%3A%2F%2Fjira-visualiser.s3.eu-west-2.amazonaws.com%2Findex.html&state=${YOUR_USER_BOUND_VALUE}&response_type=code&prompt=consent'
                } else {
                    // Send the code to lambda and swap it for an access token
                    Http = new XMLHttpRequest();
                    var jql = prompt("Please enter a JQL URL");
                    url = 'https://jok6vsojnh.execute-api.eu-west-2.amazonaws.com/default/JiraNodeVisualiser-Query';
                    Http.open("POST", url, true);
                    console.log("access token")
                    console.log(at)
                    Http.send(JSON.stringify({
                        jql: jql,
                        access_token: at
                    }))

                    Http.onreadystatechange = (e) => {
                        if (Http.readyState == 4 && Http.status == 200) {
                            console.log(Http.responseText);

                            var json = JSON.parse(Http.responseText)

                            var w = window.innerWidth,
                                h = window.innerHeight,
                                radius = 15

                            var vis = d3.select("body").append("svg:svg")
                                .attr("width", w)
                                .attr("height", h);

                            var force = self.force = d3.layout.force()
                                .nodes(json.issues)
                                .gravity(.039)
                                .distance(20)
                                .charge(-220)
                                .size([w, h])
                                .start()

                            var links = []

                            force.nodes().forEach(issue => {
                                issue.fields.subtasks && issue.fields.subtasks.forEach(subtask => {
                                    // find the item in nodes
                                    force.nodes().forEach(subtaskFind => {
                                        if (subtaskFind.key == subtask.key) {
                                            links.push({
                                                source: issue.index,
                                                target: subtaskFind.index
                                            })
                                        }
                                    })
                                })

                                issue.fields.issuelinks && issue.fields.issuelinks.forEach(issuelink => {
                                    // find the item in nodes
                                    if (issuelink.outwardIssue) {
                                        force.nodes().forEach(subtaskFind => {
                                            if (subtaskFind.key == issuelink.outwardIssue.key) {
                                                links.push({
                                                    source: issue.index,
                                                    target: subtaskFind.index
                                                })
                                            }
                                        })
                                    }

                                })
                            });

                            force.links(links)

                            force = force.start()

                            console.log(force.links())

                            var link = vis.selectAll("line.link")
                                .data(force.links())
                                .enter().append("svg:line")
                                .attr("class", function (d) {
                                    if (d.target.fields.status.name == 'To Do') {
                                        return "link-to-do"
                                    } else if (d.target.fields.status.name == 'In Progress') {
                                        return "link-in-progress"
                                    } else {
                                        return "link-done"
                                    }
                                })
                                .attr("x1", function (d) { return d.source.x; })
                                .attr("y1", function (d) { return d.source.y; })
                                .attr("x2", function (d) { return d.target.x; })
                                .attr("y2", function (d) { return d.target.y; });

                            var node_drag = d3.behavior.drag()
                                .on("dragstart", dragstart)
                                .on("drag", dragmove)
                                .on("dragend", dragend);

                            function dragstart(d, i) {
                                force.stop() // stops the force auto positioning before you start dragging
                            }

                            function dragmove(d, i) {
                                d.px += d3.event.dx;
                                d.py += d3.event.dy;
                                d.x += d3.event.dx;
                                d.y += d3.event.dy;
                                tick(); // this is the key to make it work together with updating both px,py,x,y on d !
                            }

                            function dragend(d, i) {
                                d.fixed = true; // of course set the node to fixed so the force doesn't include the node in its auto positioning stuff
                                tick();
                                force.resume();
                            }


                            var node = vis.selectAll("g.node")
                                .data(json.issues)
                                .enter().append("svg:g")
                                .attr("class", "node")
                                .call(node_drag);

                            node.append("svg:image")
                                .attr("class", "circle")
                                .attr("xlink:href", function (node) { return node.fields.issuetype.iconUrl })
                                .attr("x", "-8px")
                                .attr("y", "-8px")
                                .attr("width", "16px")
                                .attr("height", "16px")
                                .on('click', function (d) {
                                    window.open(json.url + "/projects/" + d.fields.project.key + "/issues/" + d.key)
                                });

                            node.append("svg:text")
                                .attr("class", "nodetext")
                                .attr("dx", 12)
                                .attr("dy", ".35em")
                                .text(function (d) { return d.key });

                            force.on("tick", tick);

                            function tick() {
                                link.attr("x1", function (d) { return d.source.x; })
                                    .attr("y1", function (d) { return d.source.y; })
                                    .attr("x2", function (d) { return d.target.x; })
                                    .attr("y2", function (d) { return d.target.y; });

                                node.attr("transform", function (d) { return "translate(" + Math.max(radius, Math.min(w - radius, d.x)) + "," + Math.max(radius, Math.min(h - radius, d.y)) + ")"; });
                            };
                        }
                    }
                }
            }
        }


    </script>
</body>

</html>